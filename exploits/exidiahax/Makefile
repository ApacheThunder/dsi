ifeq ($(strip $(REGION)),)
$(error "Set the REGION Makefile parameter.")
endif

HAXID	:=	2

include ../haxx_rules

REGCODE	:=	00
SREGCODE	:=	0
DEFINES	:=	
SPLITCMD	:=	
ifeq ($(REGION),USA)
	REGCODE	:=	45
	SREGCODE	:=	1
	DEFINES	:=	-DPUBSAVHAX
	PUBSAVHAX	:=	1
endif
ifeq ($(REGION),EUR)
	REGCODE	:=	56
	SREGCODE	:=	2
	DEFINES	:=	-DPUBSAVHAX
	PUBSAVHAX	:=	1
endif
ifeq ($(REGION),JP)
	REGCODE	:=	4A
	SREGCODE	:=	0
	DEFINES	:=	-DPUBSAVHAX
	PUBSAVHAX	:=	1
	SPLITCMD	:=	23951b5
endif
ifeq ($(REGCODE),00)
	$(error "Unsupported region.")
endif

all:	profile0.sav pub.sav

clean:
	rm -f exidiahax.elf profile0.sav pub.sav

profile0.sav pub.sav: exidiahax.elf pubsav.elf
	arm-eabi-objcopy -O binary exidiahax.elf profile0.sav
	../fixcrc32sum/fixcrc32sum profile0.sav
	arm-eabi-objcopy -O binary pubsav.elf pub.sav
	../fixcrc32sum/fixcrc32sum pub.sav
	cp 4B4C45$(REGCODE)input.savedata 4B4C45$(REGCODE)hax.savedata
	sudo mount -o loop 4B4C45$(REGCODE)hax.savedata exidiahax
	sudo cp ./profile0.sav exidiahax
	sudo cp ./pub.sav exidiahax
ifeq ($(PUBSAVHAX),1)
	sudo cp ./photo0.bmp exidiahax
	sudo cp ./photo3.bmp exidiahax
	sudo cp ./photo4.bmp exidiahax
	sudo cp ./photo5.bmp exidiahax
	sudo cp ./photo6.bmp exidiahax
	sudo cp ./photo9.bmp exidiahax
	sudo cp ./photo10.bmp exidiahax
	sudo cp ./photo11.bmp exidiahax
endif
	sudo ../exidia_payloadsplit/exidia_payloadsplit ../generictwlpayload/generictwlpayload.bin exidiahax $(SPLITCMD)
	sudo umount exidiahax
	cp 4B4C45$(REGCODE)hax.savedata public.sav
	../dumprawsav/dumprawsav --insav=$(CURDIR)/4B4C45$(REGCODE)hax.savedata --inban=$(CURDIR)/exidiahax.banner --cryptsav=$(CURDIR)/4B4C45$(REGCODE)hax_crypt.sav.$(HAXVER) --cryptban=$(CURDIR)/exidiahax_crypt.ban.$(HAXVER) --hashsav=4B4C45$(REGCODE)hax.savedata.sha1 --hashban=exidiahax.banner.sha1

exidiahax.elf pubsav.elf:	exidiahax.s pubsav.s
	arm-eabi-gcc -x assembler-with-cpp -nostartfiles -nostdlib -DREGCODE=$(SREGCODE) $(DEFINES) exidiahax.s -o exidiahax.elf
	arm-eabi-gcc -x assembler-with-cpp -nostartfiles -nostdlib -DREGCODE=$(SREGCODE) $(DEFINES) pubsav.s -o pubsav.elf

sdcardcp:
	save_adjust 4B4C45$(REGCODE)input.bin 4B4C45$(REGCODE)hax.bin -s 4B4C45$(REGCODE)hax.savedata -b exidiahax.banner
	cp 4B4C45$(REGCODE)hax.bin $(CARD)/private/ds/title/4B4C45$(REGCODE).bin

