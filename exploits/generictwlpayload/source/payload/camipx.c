#include "common.h"
#ifndef BOOTHB
//#define CAMINIT
#endif

#ifdef CAMINIT
void camdelay(u32 val)
{
	u32 shift=1;
	if((*((vu16*)0x04004004) & 1)==0)shift=2;

	val<<=shift;
	if(val>16)
	{
		val-=16;
		while(val>0)val-=4;
	}
}

void sendcam_msg(u32 dat0, u32 dat1)
{
	u16 oldval;
	int oldirq = REG_IME;
	REG_IME=0;
	oldval = *((vu16*)0x04004004);
	*((vu16*)0x04004004) |= 0x100;
	REG_IME=oldirq;
	if((oldval & 0x100)==0)camdelay(20);

	u32 tmp=0;
	while(sendipcmsg(21, dat0)<0);

	if(dat1)
	{
		while(sendipcmsg(21, dat1)<0);
	}

	*((vu16*)0x04004004) &= ~0x100;

	while((REG_IPC_FIFO_CR & IPC_FIFO_RECV_EMPTY)==0)tmp = REG_IPC_FIFO_RX;
}

void ipx_caminit()
{
	int i;
	if(*((u32*)0x02ffe230) != 0x4B4C4545)return;

	REG_IME = 1;

	sendcam_msg(0x2010003, 0x0);//cam total args 0x01 cmd 0x0  args: 0x03
	sendcam_msg(0x2033301, 0x30202);//cam total args 0x03 cmd 0x33 args: 0x01 0x03 0x02 0x02
	sendcam_msg(0x2033302, 0x30002);//cam total args 0x03 cmd 0x33 args: 0x02 0x03 0x00 0x02
	sendcam_msg(0x2033201, 0x30002);//cam total args 0x03 cmd 0x32 args: 0x01 0x03 0x00 0x02
	sendcam_msg(0x2033202, 0x30002);//cam total args 0x03 cmd 0x32 args: 0x02 0x03 0x00 0x02
	sendcam_msg(0x2033001, 0x30502);//cam total args 0x03 cmd 0x30 args: 0x01 0x03 0x05 0x02
	sendcam_msg(0x2033002, 0x30502);//cam total args 0x03 cmd 0x30 args: 0x02 0x03 0x05 0x02
	sendcam_msg(0x2023101, 0xE02);//cam total args 0x02 cmd 0x31 args: 0x01 0x00 0x0E 0x02
	sendcam_msg(0x2023102, 0x808C4);//cam total args 0x02 cmd 0x31 args: 0x02 0x00 0x0E 0x02
	//sendcam_msg(0x2023401, 0x10E02);//cam total args 0x02 cmd 0x34 args: 0x01 0x01 0x0E 0x02
	//sendcam_msg(0x2023402, 0x10E02);//cam totals args 0x02 cmd 0x34 args: 0x02 0x01 0x0E 0x02
	//sendcam_msg(0x2011001, 0x0);//cam total args 0x01 cmd 0x10 args: 0x01

	/**((vu16*)0x04004004) |= 4;//this block seems to be related to disabling/resetting DSP or so.
	*((vu16*)0x04004200) = 0x00;
	camdelay(30);
	*((vu16*)0x04004004) |= 0x100;
	camdelay(30);
	*((vu16*)0x04004200) = 0x22;
	camdelay(0x2008);
	*((vu16*)0x04004004) &= ~0x100;*/

	//*((vu16*)0x04004200) = 0x22;
	//*((vu16*)0x04004202) |= 0x8000;
	//*((vu16*)0x04004202) |= 0x4000;
	//*((vu16*)0x04004202) = 0xee03;

	REG_IME = 0;
}
#endif
