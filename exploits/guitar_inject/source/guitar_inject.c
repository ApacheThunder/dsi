/*
    guitar_inject.c
    /derpie
*/
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>

//#define FORMATDEBUG

/* buf should include shellcode */
static char some_bin[0x5ac] = { 0xff };

static unsigned len;
static uint8_t* buf;
static FILE* fp;
static char* file_path;

extern uint16_t crc16(uint16_t crc, const uint8_t *buffer, unsigned len);

/* load file into buf */
static int load_save()
{
	fp = fopen(file_path, "rb");
	
	if(fp == NULL) return 1;
	
	fseek(fp, 0, SEEK_END);
	len = ftell(fp);
	rewind(fp);
	
	if((buf = (uint8_t*) malloc(len)) == NULL) return 1;
	if(fread((char*) buf,len,1,fp) != 1) return 1;
	
	return 0;
}

/* update crc and save buf to file */
static int save_save()
{
	uint16_t crcA, crcAX, crcB, crcBX;
	uint16_t* _buf = (uint16_t*) buf;

	// xxx: check ranges on third args!
	_buf[0] = crc16(0, (char*) _buf+0x08, _buf[  3]+2);
	_buf[8] = crc16(0, (char*) _buf+0x18, _buf[8+3]+2);

	fp = freopen(file_path, "wb+", fp);
	
	if(fp == NULL) return 1;
	if(fwrite(buf, len, 1, fp) != 1) return 1;
		
	fclose(fp);
	free(buf);
	
	return 0;
}

int main(int argc, char* argv[])
{
	unsigned int addr = 0;
	int i;
	int diffmodei, instrumenti, songi, recordi;
	unsigned int offset = 0;
	unsigned shelloff = 0;
	int round = 0;
	FILE *fdump;
	char score[5] = "SCORE";
	char name[11];
	if(argc != 3)
	{
		printf("Usage: %s Save.bin <addr>\n", argv[0]);
		return 0;
	}
	
	file_path = argv[1];
	if(load_save() != 0)
	{
		printf("Load failed.\n");
		return 1;
	}
	/*fdump = fopen("orginal_Save.bin", "wb");
	fwrite(buf, 1, len, fdump);
	fclose(fdump);*/
	sscanf(argv[2], "%x", &addr);
	
	/* inject codez */
	memcpy(some_bin, buf+0x6a, 0x5ac);
	for(i=0x6a; i<0x1e2; i+=4)
	{
		memcpy(&buf[i], &addr, 4);
	}
	for(i=0x49e - 0x10; i<0x49e + 0x178; i+=4)
	{
		memcpy(&buf[i], &addr, 4);
	}

	for(diffmodei=0; diffmodei<3; diffmodei++)//difficultly modes
	{
		for(instrumenti=0; instrumenti<2; instrumenti++)
		{
			songi = 0;
			if(round==0)
			{
				#ifndef FORMATDEBUG
				songi = 1;
				#endif
				round = 1;
			}
			for(; songi<15; songi++)
			{
				offset = 0x1e + (0x870*diffmodei) + (0x438*instrumenti) + (0x48*songi);
				//printf("mah off iz %x d%xi%xs%x\n", offset, diffmodei, instrumenti, songi);
				#ifndef FORMATDEBUG
				if((diffmodei==0 && instrumenti==0 && songi>1) || (diffmodei || instrumenti))
				{
					for(recordi=0; recordi<5; recordi++)
					{
						//printf("rec0: %x\n", shelloff+0x6a);
						memcpy(buf+offset+(0xe*recordi), some_bin+shelloff, 4);
						shelloff+= 4;
					}
				}
				#endif
				//printf("mah newoff iz %x d%xi%xs%x\n", offset, diffmodei, instrumenti, songi);
				for(recordi=0; recordi<5; recordi++)
				{
					#ifndef FORMATDEBUG
					if(shelloff>=0x5ac)break;
					#else
					memset(name, 0x20, 10);
					//snprintf(name, 10, "D%xI%xS%xR%xX", diffmodei, instrumenti, songi, recordi);
					name[9] = 0x20;

					memcpy(buf+offset+4+(0xe*recordi), name, 10);
					memcpy(buf+offset+(0xe*recordi), score, 4);
					#endif

					//printf("rec1: %x\n", shelloff+0x6a);
					#ifndef FORMATDEBUG
					memcpy(buf+offset+4+(0xe*recordi), some_bin+shelloff, 10);
					shelloff+= 10;
					#endif
				}

				#ifndef FORMATDEBUG
				memcpy(buf+offset+(0xe*5), some_bin+shelloff, 2);
				shelloff+= 2;
				#else
				buf[offset+(0xe*5)] = 0x4A;
				buf[offset+(0xe*5)+1] = 0x4A;
				#endif
			}
		}
	}

	/*memcpy(buf+0x6a+0x00, some_bin    , 10);
	memcpy(buf+0x6a+0x0e, some_bin+10 , 10);
	memcpy(buf+0x6a+0x1c, some_bin+20 , 10);
	memcpy(buf+0x6a+0x2a, some_bin+30 , 10);
	memcpy(buf+0x6a+0x38, some_bin+40 , 16);
	memcpy(buf+0x6a+0x52, some_bin+56 , 4);
	memcpy(buf+0x6a+0x60, some_bin+60 , 4);
	memcpy(buf+0x6a+0x6e, some_bin+64 , 4);
	memcpy(buf+0x6a+0x7c, some_bin+68 , 4);
	memcpy(buf+0x6a+0x48, some_bin+72 , 10);
	memcpy(buf+0x6a+0x56, some_bin+82 , 10);
	memcpy(buf+0x6a+0x64, some_bin+92 , 10);
	memcpy(buf+0x6a+0x72, some_bin+102, 10);
	memcpy(buf+0x6a+0x80, some_bin+112, 16);
	memcpy(buf+0x6a+0x9a, some_bin+128, 4);
	memcpy(buf+0x6a+0xa8, some_bin+132, 4);
	memcpy(buf+0x6a+0xb6, some_bin+136, 4);
	memcpy(buf+0x6a+0xc4, some_bin+140, 4);
	memcpy(buf+0x6a+0x90, some_bin+144, 10);
	memcpy(buf+0x6a+0x9e, some_bin+154, 10);
	memcpy(buf+0x6a+0xac, some_bin+164, 10);
	memcpy(buf+0x6a+0xba, some_bin+174, 10);
	memcpy(buf+0x6a+0xc8, some_bin+184, 16);
	memcpy(buf+0x6a+0xe2, some_bin+200, 4);
	memcpy(buf+0x6a+0xf0, some_bin+204, 4);
	memcpy(buf+0x6a+0xfe, some_bin+208, 4);
	memcpy(buf+0x6a+0x10c,some_bin+212, 4);
	memcpy(buf+0x6a+0x102,some_bin+216, 10);
	memcpy(buf+0x6a+0x110,some_bin+226, 10);*/


	if(save_save() != 0)
	{
		printf("Save failed.\n");
		return 1;
	}
	
	return 0;
}
