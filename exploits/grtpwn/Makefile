ifeq ($(strip $(REGION)),)
$(error "Set the REGION Makefile parameter.")
endif

HAXID	:=	1

include ../haxx_rules

REGCODE	:=	00
JUMPADR	:=	
ifeq ($(REGION),USA)
	REGCODE	:=	45
	JUMPADR	:=	2040e08
endif
ifeq ($(REGION),EUR)
	REGCODE	:=	56
	JUMPADR	:=	2040e38
endif

ifeq ($(REGCODE),00)
	$(error "Unsupported region.")
endif

all:	grtpwn.s grtpwn.elf Save.bin

clean:
	rm -f grtpwn.elf shellcode.elf Save.bin 4B4752$(REGCODE)hax_crypt.sav.$(HAXVER) grtpwn_crypt.ban.$(HAXVER) 4B4752$(REGCODE).tmd.sha1 4B4752$(REGCODE)hax.savedata.sha1 grtpwn.banner.sha1

Save.bin: grtpwn.elf
	arm-eabi-objcopy -O binary grtpwn.elf Save.bin
	../genwordbin/genwordbin Save.bin 654 $(JUMPADR) --grtpwn
	../guitar_inject/guitar_inject Save.bin $(JUMPADR)
	cp 4B4752$(REGCODE)in.savedata 4B4752$(REGCODE)hax.savedata
	sudo mount -o loop 4B4752$(REGCODE)hax.savedata grtpwn
	sudo cp ./Save.bin grtpwn/GRT/Save.bin
	sudo umount grtpwn
	cp 4B4752$(REGCODE)hax.savedata public.sav
	../dumprawsav/dumprawsav --insav=$(CURDIR)/4B4752$(REGCODE)hax.savedata --inban=$(CURDIR)/grtpwn.banner --cryptsav=$(CURDIR)/4B4752$(REGCODE)hax_crypt.sav.$(HAXVER) --cryptban=$(CURDIR)/grtpwn_crypt.ban.$(HAXVER) --hashsav=4B4752$(REGCODE)hax.savedata.sha1 --hashban=grtpwn.banner.sha1

grtpwn.elf shellcode.elf:	grtpwn.s shellcode.s
	arm-eabi-gcc -x assembler-with-cpp -nostartfiles -nostdlib -DREGCODE=$(REGCODE) shellcode.s -o shellcode.elf
	arm-eabi-objcopy -O binary shellcode.elf shellcode.bin
	arm-eabi-gcc -x assembler-with-cpp -nostartfiles -nostdlib -DREGCODE=$(REGCODE) $< -o grtpwn.elf

sdcardcp:
	save_adjust 4B4752$(REGCODE)input.bin 4B4752$(REGCODE)hax.bin -s 4B4752$(REGCODE)hax.savedata -b grtpwn.banner
	cp 4B4752$(REGCODE)hax.bin $(CARD)/private/ds/title/4B4752$(REGCODE).bin

