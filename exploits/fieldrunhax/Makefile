ifeq ($(strip $(REGION)),)
$(error "Set the REGION Makefile parameter.")
endif

HAXID	:=	3

include ../haxx_rules

REGCODE	:=	00
ifeq ($(REGION),USA)
	REGCODE	:=	45
endif
ifeq ($(REGION),EUR)
	REGCODE	:=	56
endif

ifeq ($(REGCODE),00)
	$(error "Unsupported region.")
endif

all:	fieldrunhax.s fieldrunhax.elf user_defaults.plist

clean:
	rm -f fieldrunhax.elf user_defaults.plist 4B4644$(REGCODE)hax_crypt.sav.$(HAXVER) fieldrunhax_crypt.ban.$(HAXVER) 4B4644$(REGCODE).tmd.sha1 4B4644$(REGCODE)hax.savedata.sha1 fieldrunhax.banner.sha1

user_defaults.plist: fieldrunhax.elf
	arm-eabi-objcopy -O binary fieldrunhax.elf user_defaults.plist
	../fixcrc32sum/fixcrc32sum user_defaults.plist --crc32_off=0 --crc32dat_off=4 "--filler=58,384,104"
	cp 4B4644$(REGCODE)in.savedata 4B4644$(REGCODE)hax.savedata
	sudo mount -o loop 4B4644$(REGCODE)hax.savedata fieldrunhax
	sudo cp ./user_defaults.plist fieldrunhax/user_defaults.plist
	sudo umount fieldrunhax
	cp 4B4644$(REGCODE)hax.savedata public.sav
	../dumprawsav/dumprawsav --insav=$(CURDIR)/4B4644$(REGCODE)hax.savedata --inban=$(CURDIR)/fieldrunhax.banner --cryptsav=$(CURDIR)/4B4644$(REGCODE)hax_crypt.sav.$(HAXVER) --cryptban=$(CURDIR)/fieldrunhax_crypt.ban.$(HAXVER) --hashsav=4B4644$(REGCODE)hax.savedata.sha1 --hashban=fieldrunhax.banner.sha1

fieldrunhax.elf:	fieldrunhax.s
	arm-eabi-gcc -x assembler-with-cpp -nostartfiles -nostdlib -DREGCODE=$(REGCODE) $< -o fieldrunhax.elf

sdcardcp:
	save_adjust 4B4644$(REGCODE)input.bin 4B4644$(REGCODE)hax.bin -s 4B4644$(REGCODE)hax.savedata -b fieldrunhax.banner
	cp 4B4644$(REGCODE)hax.bin $(CARD)/private/ds/title/4B4644$(REGCODE).bin

